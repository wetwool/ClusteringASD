---
title: "GLMAnalysis"
output: html_document
---
Setup:

```{r}
library("fsbrain")
library("freesurferformats")
library("stringr")
source("ASDClusteringParams.R", local= knitr::knit_global())
setwd(params$WorkingDirectory)

```

```{r}
getResultsDirPath <- function(baseDir, hemisphere, projectname, feature, kernelsize, contrastsName) {
  return(
    paste(
      baseDir,
      hemisphere, ".",
      projectname, ".",
      feature, ".",
      kernelsize, ".glmdir/",
      contrastsName, "/",
      sep = ""
    )
  )
}
getGLMResultFiles <- function(dir, threshold, direction) {
  prefix <- paste(dir, "cache.th", as.numeric(threshold)*10,".", direction,".sig.", sep ="")
  return(
    list(
      cluster.summary = paste(prefix, "cluster.summary",sep=""),
      cluster = paste(prefix,"cluster.mgh",sep=""),
      sig = paste(dir, "sig.mgh",sep=""),
      z = paste(dir, "z.mgh",sep=""),
      gamma = paste(dir, "gamma.mgh",sep="")
    )
  )
}
processSummaryFile <- function(summary) {
  fileConn <- file(summary, "r")
  lines <- readLines(fileConn)
  close(fileConn)
  passedHeader = F
  summaryRaw <- c()
  for (line in lines) {
    if (passedHeader) {
      summaryRaw <- append(summaryRaw, line)
    }
    if (startsWith(line, "# ClusterNo")){
      summaryRaw <- c(substr(line, start = 3, stop = 1000))
      passedHeader = T
    }
  }
  summaryCleaned <- c()
  for (line in summaryRaw) {
    summaryCleaned <- append(summaryCleaned, str_replace_all(str_squish(line)," ", ";"))
  }
  summaryDF <- read.table(text = paste(summaryCleaned, collapse = "\n"), sep = ";", header = T, stringsAsFactors = F)
  return(summaryDF)
}
```

```{r}
GLMProjects <- c(params$GLMProjects$ClusteredASD$Title, params$GLMProjects$ClusteredASDvHC$Title, params$GLMProjects$ASDvHC$Title)
analysisNames <- c()
glmResultFiles <- list()
glmResultData <- data.frame()
for (project in GLMProjects) {
  for (hemi in params$Hemis){
    for (feature in params$Features){
      dir <- getResultsDirPath(baseDir = params$GLMFolder, hemisphere = hemi, 
                               projectname = project, feature =  feature,
                               kernelsize = params$GLMCacheKernel, contrastsName = project)
      resFiles <- getGLMResultFiles(dir, params$GLMCacheValue, params$GLMDirections$absolute)
      summary <- processSummaryFile(resFiles$cluster.summary)
      
      name <- paste(project, hemi,feature, sep =".")
      if (nrow(summary) >= 1){
        summary$analysis <- name
        summary <- summary[, c(ncol(summary), 2:(ncol(summary)-1))]
        analysisNames <- append(analysisNames, name)
        glmResultData <- rbind(glmResultData, summary)
      }
      glmResultFiles[[project]][[paste(hemi,feature, sep =".")]]<- list (
        files = resFiles
      )
    }
  }
}

```

```{r}
project <- params$GLMProjects$ClusteredASDvHC$Title
analysisNames <- c()
glmResultFiles <- list()
glmResultData <- data.frame()
for (hemi in params$Hemis){
  for (feature in params$Features){
    for (contrast in params$GLMProjects$ClusteredASDvHC$ContrastPerms) {
      dir <- getResultsDirPath(baseDir = params$GLMFolder, hemisphere = hemi, 
                               projectname = project, feature =  feature,
                               kernelsize = params$GLMCacheKernel, contrastsName = paste(project, contrast, sep=""))
      resFiles <- getGLMResultFiles(dir, params$GLMCacheValue, params$GLMDirections$absolute)
      summary <- processSummaryFile(resFiles$cluster.summary)
      
      name <- paste(project, hemi ,feature, sep =".")
      if (nrow(summary) >= 1){
        summary$analysis <- name
        summary$contrast <- contrast
        summary <- summary[, c(ncol(summary), 2:(ncol(summary)-1))]
        analysisNames <- append(analysisNames, name)
        glmResultData <- rbind(glmResultData, summary)
      }
      glmResultFiles[[project]][[contrast]][[paste(hemi,feature, sep =".")]]<- list (
        files = resFiles
      )
    }
  }
}


```
Significant Clusters
```{r}
glmOverview <- glmResultData[order(glmResultData$VtxMax,decreasing = T),c("analysis","contrast", "Size.mm.2." , "CWP","Annot")]
glmOverview
write.csv(glmResultData, file="glmResultDataContrasts.csv", sep=";")
```
```{r}
glmResultData[glmResultData$contrast == "10-1" | glmResultData$contrast == "01-1",c("analysis","contrast", "WghtVtx" , "CWP","Annot")]
```

```{r}
fsaverage = "E:/Linux/Exchange/fsaverage"

subj_dir = "E:/Linux/Exchange/Site-SI_Derivatives_UZH"

displayMGH <- function(fileCollection,feature, type){
  # browser()
 colFn_diverging  = grDevices::colorRampPalette(RColorBrewer::brewer.pal(11, name="RdBu"));
  lh_clust = read.fs.morph (unlist(fileCollection[[paste("lh.",feature, sep="")]]$files[type]), "mgh")
  rh_clust = read.fs.morph (unlist(fileCollection[[paste("rh.",feature,sep="")]]$files[type]), "mgh")
  
  # rgla = list('trans_fun'=limit_fun(0.0000001,100));
  vis.data.on.fsaverage(subj_dir, surface = "pial", morph_data_lh = lh_clust, morph_data_rh = rh_clust,bg="aparc", style ="default",  views=c('t4'),draw_colorbar =T, makecmap_options = list('colFn'=colFn_diverging, 'symm'=TRUE))#,rglactions=rgla)
}

displayMGH(glmResultFiles$ClusteredASDvtHC$noVars,"thickness", "cluster")

displayMGH(glmResultFiles$ClusteredASDvtHC$noVars,"area", "cluster")
displayMGH(glmResultFiles$ClusteredASDvtHC$Vars,"thickness", "cluster")
displayMGH(glmResultFiles$ClusteredASDvtHC$Vars,"area", "cluster")

displayMGH(glmResultFiles$ClusterASDvHCComparison$`10-1`,"area", "cluster")
displayMGH(glmResultFiles$ClusterASDvHCComparison$`10-1`,"thickness", "cluster")
displayMGH(glmResultFiles$ClusterASDvHCComparison$`01-1`,"area", "cluster")
displayMGH(glmResultFiles$ClusterASDvHCComparison$`01-1`,"thickness", "cluster")

```