---
title: "DataExploration"
output: html_document
---
Setup:
```{r}
library(ggplot2)
library(png)
library(pheatmap)
library(NbClust)
library(cluster)
library(plyr)
library(dplyr)
library(plotly)
library(ggpubr)
library(factoextra)
source("ASDClusteringParams.R", local= knitr::knit_global())

setwd(params$WorkingDirectory)
load(file = params$FilteredDataFile)
PR <- read.csv(params$ParcellationReferenceFile, sep = ";",stringsAsFactors = F)
```


```{r}
zScore <- function(value, distribution) {
  z <- NA
  if(length(distribution) > params$zScoringMinGroupSize){
    z <- (as.numeric(value) - mean(distribution))/sd(distribution)
  } 
  return(z)
}

zScore_SBJ <- function(s, ftrs, hc) {
  for (f in ftrs) {
    value <- s[f]
    # controlDistribution <- hc[which(round(as.numeric(hc$Age)) == round(as.numeric(s["Age"])) &  hc["site"] == s["site"]),f]
    if (params$zScoringBySite){
      controlDistribution <- hc[which(abs(hc$Age - s["Age"]) < params$zScoringAgeRange &  hc["site"] == s["site"]),f]
      
    } else{
      controlDistribution <- hc[which(abs(hc$Age - s["Age"]) < params$zScoringAgeRange),f]
    }
    s[f] <- zScore(value, controlDistribution)
  }
  return(s)
}

zScore_SBJ_loop <- function(sbj, ftrs, hc) {
  res = list()
  for (i in 1:ncol(sbj)) {
    for (f in ftrs) {
      value <- sbj[i, f]
      # controlDistribution <- hc[which(round(as.numeric(hc$Age)) == round(as.numeric(sbj[i,"Age"])) &  hc[,"site"] == sbj[i,"site"]),f]
      if (params$zScoringBySite){
        controlDistribution <- hc[which((abs(hc$Age - sbj[i,"Age"]) < params$zScoringAgeRange) &  hc[,"site"] == sbj[i,"site"]),f]
      } else {
        controlDistribution <- hc[which((abs(hc$Age - sbj[i,"Age"]) < params$zScoringAgeRange)),f]
      }
      # browser()
      sbj[i,f] <- zScore(value, controlDistribution)
    }
  }
  return(sbj)
}

zScore_leaveOut <- function(s, ftrs, df) {
  for (f in ftrs) {
    # value <- s[f]
    # controlDistribution <- df[which(round(as.numeric(df$Age)) == round(as.numeric(s["Age"])) &  
    #                                   df["site"] == s["site"] &  
    #                                   df["Subject"] == s["Subject"] & 
    #                                   df[params$VID] != s[params$VID]),f]    # value <- s[f]
    if (params$zScoringBySite){
      controlDistribution <- df[which(abs(hc$Age - s["Age"]) < params$zScoringAgeRange  &
                                        df["site"] == s["site"] &
                                        df["Subject"] == s["Subject"] &
                                        df[params$VID] != s[params$VID]),f]
    } else {
      controlDistribution <- df[which(abs(hc$Age - s["Age"]) < params$zScoringAgeRange  &
                                        df["Subject"] == s["Subject"] &
                                        df[params$VID] != s[params$VID]),f]
    }
    
    s[f] <- zScore(value, controlDistribution)
  }
  return(s)
}
zScore_leaveOut_loop <- function(sbj, ftrs, df) {
  res = list()
  for (i in 1:nrow(sbj)) {
    # nControlDistribution = length(df[which(round(as.numeric(df$Age)) == round(as.numeric(sbj[i,"Age"])) &  
    #                                   df[,"site"] == sbj[i,"site"] &  
    #                                   df[,"Subject"] == sbj[i,"Subject"] & 
    #                                   df[,params$VID] != sbj[i,params$VID]),"Age"])
    if (params$zScoringBySite){
      nControlDistribution = length(df[which(round(abs(df$Age - sbj[i,"Age"]) < params$zScoringAgeRange)  &  
                                               df[,"site"] == sbj[i,"site"] &  
                                               df[,"Subject"] == sbj[i,"Subject"] & 
                                               df[,params$VID] != sbj[i,params$VID]),"Age"])
    } else {    
      nControlDistribution = length(df[which(round(abs(df$Age - sbj[i,"Age"]) < params$zScoringAgeRange)  &    
                                               df[,"Subject"] == sbj[i,"Subject"] & 
                                               df[,params$VID] != sbj[i,params$VID]),"Age"]) }
    for (f in ftrs) {
      value <- sbj[i, f]
      # controlDistribution <- df[which(round(as.numeric(df$Age)) == round(as.numeric(sbj[i,"Age"])) &  
      #                               df[,"site"] == sbj[i,"site"] &  
      #                               df[,"Subject"] == sbj[i,"Subject"] & 
      #                               df[,params$VID] != sbj[i,params$VID]),f]
      if (params$zScoringBySite){
        controlDistribution <- df[which(round(abs(df$Age - sbj[i,"Age"]) < params$zScoringAgeRange)  &  
                                          df[,"site"] == sbj[i,"site"] &  
                                          df[,"Subject"] == sbj[i,"Subject"] & 
                                          df[,params$VID] != sbj[i,params$VID]),f]
      } else {  
        controlDistribution <- df[which(round(abs(df$Age - sbj[i,"Age"]) < params$zScoringAgeRange)  &    
                                          df[,"Subject"] == sbj[i,"Subject"] & 
                                          df[,params$VID] != sbj[i,params$VID]),f]
      }
      sbj[i,f] <- zScore(value, controlDistribution)
    }
    
    # sbj[i,]$countZDistribution <- nControlDistribution
  }
  return(sbj)
}

```


```{r}
areas <- append(PR$Area_Left[PR$Area_Left != "" & PR$isParcell == 1], PR$Area_Right[PR$Area_Right != "" & PR$isParcell == 1])
thicknesses <- append(PR$Thickness_Left[PR$Thickness_Left != "" & PR$isParcell == 1], PR$Thickness_Right[PR$Thickness_Right != "" & PR$isParcell == 1])
features <- append(areas,thicknesses)

data[,features] <- lapply(data[,features], as.numeric)
data$Age <- as.numeric(data$Age)

rhm <- data[which(data$Sex == params$Sex & data$EHQ_Total > params$EHQCutoff),]# & data$Protocol == params$Protocols$HCP),]
rhm$site <- factor(rhm$site)

# GLM to extract residuals of [features] ~ Age, Site
formPredictors <- "~ Age * site"
if (params$EHQInResidualCalc) {
  formPredictors <- "~ Age * site * EHQ_Total"
}

for (feature in features) {
  form <- formula(paste(feature,formPredictors)) # change to interaction
  model <- glm(form, data=rhm)
  rhm[,feature] <- model$residuals
}
```

z-scoring of [features] vs HC distribution
```{r}
# zScored <- data
sbj <- rhm[which(rhm$Subject == 1),]# & !is.na(rhm[,features])
hC <- rhm[which(rhm$Subject == 0 & rhm$dxCount <= params$MaxDiagnosisCount),]

asdZScored <-zScore_SBJ_loop(sbj, features, hC)
asdZScored <- asdZScored[complete.cases(asdZScored[,features]),]
hcZScored <- zScore_leaveOut_loop(hC,features,hC)
hcZScored <- hcZScored[complete.cases(hcZScored[,features]),]
nrow(asdZScored)
nrow(hcZScored)
```


Clustering
```{r}
featureMatrix <-asdZScored[,features]
asd_distance = dist(featureMatrix, method= params$Distance)
nbResultDB <- NbClust(asdZScored[,features], min.nc = 2, max.nc = 20, method = params$ClusterMethod, index="db")
nbResultDB$Best.nc[1]
params$kList$db = nbResultDB$Best.nc[1]
nbResultSi <- NbClust(asdZScored[,features], min.nc = 2, max.nc = 20, method = params$ClusterMethod, index="silhouette")
nbResultSi$Best.nc[1]
params$kList$silhouette = nbResultSi$Best.nc[1]
# silhouetteResult <- silhouette(2:20, dist = distance)

hcRes = hclust(asd_distance, params$ClusterMethod)
groups = cutree(hcRes, k = params$k())# nbResultDB$Best.nc[1]) #
table(groups)
asdZScored$clust <- groups
```

```{r}
hc_featureMatrix <-hcZScored[,features]
hc_distance = dist(hc_featureMatrix, method=params$Distance)
hc_nbResultDB <- NbClust(hcZScored[,features], min.nc = 2, max.nc = 20, method = params$ClusterMethod, index="db")
hc_nbResultDB$Best.nc[1]
hc_nbResultSi <- NbClust(hcZScored[,features], min.nc = 2, max.nc = 20, method = params$ClusterMethod, index="silhouette")
hc_nbResultSi$Best.nc[1]
# silhouetteResult <- silhouette(2:20, dist = distance)
clusterRes = hclust(hc_distance, params$ClusterMethod)
hc_groups = cutree(clusterRes, k = params$k())# nbResultDB$Best.nc[1]) #
table(hc_groups)
hcZScored$clust <- hc_groups
```
```{r}
  save(asdZScored, file = params$zScoredASDDataFile2, ascii = T)
  save(hcZScored, file = params$zScoredHCDataFile2, ascii = T)
```
